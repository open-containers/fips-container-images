name: FIPS Container Security Scan

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  schedule:
    - cron: '0 2 * * *'  # Daily at 2 AM UTC
  workflow_dispatch:  # Manual trigger

permissions:
  contents: read
  security-events: write
  actions: read

# Cancel in-progress runs for the same workflow
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  discover-dockerfiles:
    name: Discover All Dockerfiles
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
      has-dockerfiles: ${{ steps.set-matrix.outputs.has-dockerfiles }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Find all Dockerfiles
        id: set-matrix
        run: |
          # Find all Dockerfiles recursively
          dockerfiles=$(find . -type f \( -name "Dockerfile*" -o -name "*.dockerfile" \) | jq -R -s -c 'split("\n")[:-1]')
          echo "matrix=${dockerfiles}" >> $GITHUB_OUTPUT
          echo "Found Dockerfiles: ${dockerfiles}"
          
          # Check if any dockerfiles were found
          if [ "$dockerfiles" = "[]" ] || [ "$dockerfiles" = "" ]; then
            echo "has-dockerfiles=false" >> $GITHUB_OUTPUT
            echo "âš ï¸ No Dockerfiles found in repository"
          else
            echo "has-dockerfiles=true" >> $GITHUB_OUTPUT
            dockerfile_count=$(echo "$dockerfiles" | jq 'length')
            echo "âœ“ Found ${dockerfile_count} Dockerfile(s)"
          fi

  build-and-scan:
    name: Build & Scan
    needs: discover-dockerfiles
    if: ${{ needs.discover-dockerfiles.outputs.has-dockerfiles == 'true' }}
    runs-on: ubuntu-latest
    timeout-minutes: 30
    strategy:
      fail-fast: false
      matrix:
        dockerfile: ${{ fromJson(needs.discover-dockerfiles.outputs.matrix) }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Generate image name
        id: image-name
        run: |
          # Create unique image name from dockerfile path (must be lowercase)
          DOCKERFILE_PATH="${{ matrix.dockerfile }}"
          IMAGE_NAME=$(echo "${DOCKERFILE_PATH}" | sed 's/[\/\.]/-/g; s/^-//; s/.*/\L&/')
          echo "name=fips-${IMAGE_NAME}:latest" >> $GITHUB_OUTPUT
          echo "Building: fips-${IMAGE_NAME}:latest"
      
      - name: Build FIPS Docker Image
        run: |
          docker build \
            --file "${{ matrix.dockerfile }}" \
            --tag "${{ steps.image-name.outputs.name }}" \
            --label "fips-compliant=true" \
            --label "built-by=github-actions" \
            --label "build-date=$(date -u +'%Y-%m-%dT%H:%M:%SZ')" \
            --label "source-commit=${{ github.sha }}" \
            .
      
      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@0.33.0
        with:
          image-ref: ${{ steps.image-name.outputs.name }}
          format: 'sarif'
          output: 'trivy-results-${{ matrix.dockerfile }}.sarif'
          severity: 'CRITICAL,HIGH,MEDIUM'
          vuln-type: 'os,library'
          exit-code: '0'
          cache-dir: .trivy
      
      - name: Upload Trivy SARIF results to GitHub Security
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: 'trivy-results-${{ matrix.dockerfile }}.sarif'
          category: 'trivy-${{ steps.image-name.outputs.name }}'
      
      - name: Generate JSON report for artifacts
        uses: aquasecurity/trivy-action@0.33.0
        if: always()
        with:
          image-ref: ${{ steps.image-name.outputs.name }}
          format: 'json'
          output: 'trivy-results-${{ matrix.dockerfile }}.json'
          severity: 'CRITICAL,HIGH,MEDIUM'
          cache-dir: .trivy
      
      - name: Upload detailed scan results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: trivy-scan-${{ steps.image-name.outputs.name }}
          path: |
            trivy-results-${{ matrix.dockerfile }}.json
            trivy-results-${{ matrix.dockerfile }}.sarif
          retention-days: 30
      
      - name: Check for CRITICAL vulnerabilities
        run: |
          CRITICAL_COUNT=$(jq '[.Results[]?.Vulnerabilities[]? | select(.Severity=="CRITICAL")] | length' trivy-results-${{ matrix.dockerfile }}.json)
          echo "Found ${CRITICAL_COUNT} CRITICAL vulnerabilities"
          
          if [ "$CRITICAL_COUNT" -gt 0 ]; then
            echo "::error::CRITICAL vulnerabilities found in ${{ matrix.dockerfile }}"
            jq -r '.Results[]?.Vulnerabilities[]? | select(.Severity=="CRITICAL") | "- \(.VulnerabilityID): \(.PkgName) \(.InstalledVersion) -> \(.FixedVersion // "no fix available")"' trivy-results-${{ matrix.dockerfile }}.json
            exit 1
          fi

  fips-validation:
    name: FIPS Compliance Check
    needs: discover-dockerfiles
    if: ${{ needs.discover-dockerfiles.outputs.has-dockerfiles == 'true' }}
    runs-on: ubuntu-latest
    timeout-minutes: 20
    strategy:
      fail-fast: false
      matrix:
        dockerfile: ${{ fromJson(needs.discover-dockerfiles.outputs.matrix) }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Build Image for FIPS Testing
        run: |
          DOCKERFILE_PATH="${{ matrix.dockerfile }}"
          IMAGE_NAME=$(echo "${DOCKERFILE_PATH}" | sed 's/[\/\.]/-/g; s/^-//; s/.*/\L&/')
          docker build -f "${{ matrix.dockerfile }}" -t "fips-${IMAGE_NAME}:test" .
          echo "IMAGE_NAME=fips-${IMAGE_NAME}:test" >> $GITHUB_ENV
          echo "Building image: fips-${IMAGE_NAME}:test"
      
      - name: Verify FIPS Module Installation
        run: |
          echo "Checking for FIPS cryptographic modules..."
          
          # Check for OpenSSL FIPS provider
          docker run --rm "${{ env.IMAGE_NAME }}" sh -c "
            if command -v openssl >/dev/null 2>&1; then
              echo '=== OpenSSL Version ==='
              openssl version -a
              
              echo '=== FIPS Provider Check ==='
              if openssl list -providers 2>/dev/null | grep -i fips; then
                echo 'âœ“ FIPS provider found'
              else
                echo 'âš  FIPS provider not found'
              fi
            fi
          " || echo "OpenSSL not installed in this image"
      
      - name: Check for non-FIPS algorithms
        run: |
          echo "Scanning Dockerfile for deprecated/non-FIPS algorithms..."
          
          # Check for MD5, SHA1 in non-HMAC context, DES, RC4
          if grep -iE '(md5|des|rc4)' "${{ matrix.dockerfile }}"; then
            echo "::warning::Potentially non-FIPS algorithms found in ${{ matrix.dockerfile }}"
          else
            echo "âœ“ No obvious non-FIPS algorithms detected"
          fi

  dockerfile-lint:
    name: Dockerfile Lint
    needs: discover-dockerfiles
    if: ${{ needs.discover-dockerfiles.outputs.has-dockerfiles == 'true' }}
    runs-on: ubuntu-latest
    timeout-minutes: 15
    strategy:
      fail-fast: false
      matrix:
        dockerfile: ${{ fromJson(needs.discover-dockerfiles.outputs.matrix) }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Run Trivy config scan on Dockerfile
        uses: aquasecurity/trivy-action@0.33.0
        with:
          scan-type: 'config'
          scan-ref: ${{ matrix.dockerfile }}
          format: 'sarif'
          output: 'trivy-config-${{ matrix.dockerfile }}.sarif'
          exit-code: '0'
      
      - name: Upload Trivy config scan results
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: 'trivy-config-${{ matrix.dockerfile }}.sarif'
          category: 'trivy-config-${{ matrix.dockerfile }}'
      
      - name: Run Hadolint on ${{ matrix.dockerfile }}
        uses: hadolint/hadolint-action@v3.1.0
        with:
          dockerfile: ${{ matrix.dockerfile }}
          format: 'sarif'
          output-file: 'hadolint-${{ matrix.dockerfile }}.sarif'
          no-fail: true
      
      - name: Upload Hadolint results
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: 'hadolint-${{ matrix.dockerfile }}.sarif'
          category: 'hadolint-${{ matrix.dockerfile }}'

  security-summary:
    name: Security Summary
    needs: [discover-dockerfiles, build-and-scan, fips-validation, dockerfile-lint]
    runs-on: ubuntu-latest
    if: always()
    
    steps:
      - name: Check if Dockerfiles exist
        id: check
        run: |
          if [ "${{ needs.discover-dockerfiles.outputs.has-dockerfiles }}" != "true" ]; then
            echo "skip-summary=true" >> $GITHUB_OUTPUT
          else
            echo "skip-summary=false" >> $GITHUB_OUTPUT
          fi
      
      - name: Download all scan artifacts
        if: steps.check.outputs.skip-summary == 'false'
        uses: actions/download-artifact@v4
        with:
          path: scan-results
      
      - name: Generate summary report
        if: steps.check.outputs.skip-summary == 'false'
        run: |
          echo "# ðŸ”’ FIPS Container Security Scan Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Scan Date:** $(date -u +'%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "**Workflow Run:** #${{ github.run_number }}" >> $GITHUB_STEP_SUMMARY
          echo "**Triggered by:** ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Count total vulnerabilities across all images
          if [ -d "scan-results" ]; then
            TOTAL_CRITICAL=0
            TOTAL_HIGH=0
            TOTAL_MEDIUM=0
            IMAGE_COUNT=0
            
            for json_file in scan-results/*/*.json; do
              if [ -f "$json_file" ]; then
                IMAGE_COUNT=$((IMAGE_COUNT + 1))
                CRITICAL=$(jq '[.Results[]?.Vulnerabilities[]? | select(.Severity=="CRITICAL")] | length' "$json_file" || echo 0)
                HIGH=$(jq '[.Results[]?.Vulnerabilities[]? | select(.Severity=="HIGH")] | length' "$json_file" || echo 0)
                MEDIUM=$(jq '[.Results[]?.Vulnerabilities[]? | select(.Severity=="MEDIUM")] | length' "$json_file" || echo 0)
                
                TOTAL_CRITICAL=$((TOTAL_CRITICAL + CRITICAL))
                TOTAL_HIGH=$((TOTAL_HIGH + HIGH))
                TOTAL_MEDIUM=$((TOTAL_MEDIUM + MEDIUM))
              fi
            done
            
            echo "## ðŸ“Š Vulnerability Summary" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Images Scanned:** ${IMAGE_COUNT}" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "| Severity | Count |" >> $GITHUB_STEP_SUMMARY
            echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
            echo "| ðŸ”´ CRITICAL | $TOTAL_CRITICAL |" >> $GITHUB_STEP_SUMMARY
            echo "| ðŸŸ  HIGH | $TOTAL_HIGH |" >> $GITHUB_STEP_SUMMARY
            echo "| ðŸŸ¡ MEDIUM | $TOTAL_MEDIUM |" >> $GITHUB_STEP_SUMMARY
            
            # Set job status based on findings
            if [ "$TOTAL_CRITICAL" -gt 0 ]; then
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "âš ï¸ **Action Required:** Critical vulnerabilities detected!" >> $GITHUB_STEP_SUMMARY
            elif [ "$TOTAL_HIGH" -gt 0 ]; then
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "âš ï¸ **Warning:** High severity vulnerabilities detected" >> $GITHUB_STEP_SUMMARY
            else
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "âœ… **Status:** No critical or high vulnerabilities detected" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "âš ï¸ No scan results found" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“‹ **View detailed results:**" >> $GITHUB_STEP_SUMMARY
          echo "- [Security Tab](${{ github.server_url }}/${{ github.repository }}/security/code-scanning)" >> $GITHUB_STEP_SUMMARY
          echo "- [Workflow Run](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})" >> $GITHUB_STEP_SUMMARY
      
      - name: No Dockerfiles Found Summary
        if: steps.check.outputs.skip-summary == 'true'
        run: |
          echo "# ðŸ”’ FIPS Container Security Scan Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âš ï¸ **No Dockerfiles found in repository**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "The workflow searched for files matching:" >> $GITHUB_STEP_SUMMARY
          echo "- \`Dockerfile*\` (e.g., Dockerfile, Dockerfile.python)" >> $GITHUB_STEP_SUMMARY
          echo "- \`*.dockerfile\` (e.g., python.dockerfile)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Please verify your repository structure and ensure Dockerfiles exist." >> $GITHUB_STEP_SUMMARY

